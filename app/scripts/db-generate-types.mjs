import { spawnSync } from "child_process"
import { mkdirSync, writeFileSync } from "fs"
import { dirname, resolve } from "path"
import { fileURLToPath } from "url"

import {
  getDefaultEnvFiles,
  getMissingKeys,
  getProjectRefFromSupabaseUrl,
  loadEnvFiles,
  parseModeArg,
} from "./env-utils.mjs"

const scriptDir = dirname(fileURLToPath(import.meta.url))
const siteDir = resolve(scriptDir, "..")
const mode = parseModeArg(process.argv.slice(2), process.env.APP_ENV || "local")

loadEnvFiles(siteDir, getDefaultEnvFiles(mode))

const requiredKeys = ["NEXT_PUBLIC_SUPABASE_URL"]
const missingKeys = getMissingKeys(requiredKeys)
if (missingKeys.length > 0) {
  console.error(`Cannot generate types; missing keys: ${missingKeys.join(", ")}`)
  process.exit(1)
}

const commandCheck = spawnSync("supabase", ["--version"], { stdio: "ignore" })
if (commandCheck.status !== 0) {
  console.error("Supabase CLI is required but not available in PATH.")
  process.exit(1)
}

const projectRef = getProjectRefFromSupabaseUrl(process.env.NEXT_PUBLIC_SUPABASE_URL)

let result = null

if (projectRef) {
  result = spawnSync(
    "supabase",
    [
      "gen",
      "types",
      "--project-id",
      projectRef,
      "--lang",
      "typescript",
      "--schema",
      "public",
      "--schema",
      "auth",
    ],
    {
      cwd: siteDir,
      encoding: "utf-8",
    }
  )
}

// Fallback for environments where project-id generation is unavailable.
if (!result || result.status !== 0) {
  const fallbackUrl = process.env.POSTGRES_URL_NON_POOLING || process.env.POSTGRES_URL
  if (!fallbackUrl) {
    process.stderr.write(
      (result?.stderr || "") +
        "Type generation failed via project-id and no POSTGRES_URL fallback is configured.\n"
    )
    process.exit(result?.status ?? 1)
  }

  result = spawnSync(
    "supabase",
    [
      "gen",
      "types",
      "--lang",
      "typescript",
      "--db-url",
      fallbackUrl,
      "--schema",
      "public",
      "--schema",
      "auth",
    ],
    {
      cwd: siteDir,
      encoding: "utf-8",
    }
  )
}

if (result.status !== 0) {
  process.stderr.write(result.stderr || "Type generation failed.\n")
  process.exit(result.status ?? 1)
}

const outputFile = resolve(siteDir, "src/types/database.generated.ts")
mkdirSync(dirname(outputFile), { recursive: true })

const header = [
  "// Generated by: npm run db:types",
  `// Generated at: ${new Date().toISOString()}`,
  "",
].join("\n")

writeFileSync(outputFile, `${header}${result.stdout}`)
console.log(`Generated database types at ${outputFile}`)
