```md
# Advyser V1 — Routes + Permissions Map (AU)
Goal: define URL routes, required auth, roles, and access rules so implementation is unambiguous.

Roles:
- Public (unauthenticated)
- Consumer (role=consumer)
- Advisor (role=advisor)
- Admin (role=admin)

Conventions:
- Public routes live under `/`
- Consumer app routes under `/app`
- Advisor app routes under `/advisor`
- Admin console under `/admin`

Auth Rules:
- Public pages are readable without login.
- Consumer actions that create leads/messages require consumer login.
- Advisor dashboard requires advisor login + business association (claimed) for full access.
- Admin routes require admin role.

---

## 1) Public Marketing + Marketplace

### Home
- `GET /`
  - Access: Public
  - Notes: shows search module + categories

### Search results
- `GET /search`
  - Access: Public
  - Query params:
    - `type` (advisor type)
    - `q` (free text)
    - `loc` (suburb/postcode/state)
    - `lat,lng` (optional)
    - `radius_km`
    - filter params (specialties, verified, mode, etc.)
  - Notes: browsing allowed without login

### Listing profile
- `GET /advisors/:listing_slug` (or `/:type/:location/:business`)
  - Access: Public
  - Notes:
    - Shows profile
    - If unclaimed, shows CTA "Claim this business" → `/claim`

### For Advisors landing
- `GET /for-advisors`
  - Access: Public
  - Notes: explains listing + dashboard + Copilot value

### About/Legal
- `GET /about`
- `GET /privacy`
- `GET /terms`
- `GET /contact`
  - Access: Public

### Report a listing
- `GET /report/:listing_id`
  - Access: Public (preferred) or Consumer (optional)
- `POST /report/:listing_id`
  - Access: Public (email required) OR logged-in
  - Notes: rate limit to prevent abuse

---

## 2) Auth

### Login / Signup
- `GET /login`
- `GET /signup`
- `POST /api/auth/login`
- `POST /api/auth/signup`
  - Access: Public
  - Notes:
    - After signup/login, redirect to last intended action:
      - If user tried to request intro → `/request/:listing_id`
      - If user tried to claim → `/claim`

### Email verification (optional)
- `GET /verify-email?token=...`
  - Access: Public

### Password reset (optional)
- `GET /forgot-password`
- `POST /api/auth/forgot-password`
- `GET /reset-password?token=...`
- `POST /api/auth/reset-password`
  - Access: Public

---

## 3) Consumer Flow

### Request intro (lead form)
- `GET /request/:listing_id`
  - Access: Public (read)
  - Guard: if not logged in, allow form fill but block submit with auth modal
- `POST /api/leads`
  - Access: Consumer only
  - Guardrails:
    - listing must be active
    - consent checkbox required

### Consumer app shell
- `GET /app`
  - Access: Consumer only
  - Redirect:
    - If advisor role → `/advisor`
    - If admin role → `/admin`

### My Requests
- `GET /app/requests`
  - Access: Consumer only

### Request detail
- `GET /app/requests/:lead_id`
  - Access: Consumer only
  - Authorization:
    - lead.consumer_user_id == current user

### Messages (optional consolidated)
- `GET /app/messages`
  - Access: Consumer only

### Conversation detail
- `GET /app/messages/:conversation_id`
  - Access: Consumer only
  - Authorization:
    - conversation.lead.consumer_user_id == current user

### Send message
- `POST /api/conversations/:conversation_id/messages`
  - Access: Consumer only
  - Authorization:
    - as above
  - Notes:
    - attachments allowed

### Consumer settings
- `GET /app/settings`
  - Access: Consumer only

---

## 4) Advisor Claim + Onboarding

### Claim entry
- `GET /claim`
  - Access: Public (preferred)
  - Notes: search business + start claim wizard

### Claim for specific listing/business
- `GET /claim/:business_id`
  - Access: Public (preferred) or Advisor
  - Notes: pre-fills selected business

### Submit claim
- `POST /api/claims`
  - Access: Advisor OR Public (if you allow converting user to advisor)
  - Recommended V1 approach:
    - Require login first; if user is consumer, allow role upgrade to advisor during claim
  - Guard:
    - rate limit attempts per user + IP
    - must pass proof-of-control step before status becomes "pending"

### Claim status page
- `GET /claim/status/:claim_request_id`
  - Access: Logged-in user only
  - Authorization:
    - claim_request.requester_user_id == current user

---

## 5) Advisor Dashboard (Supply Side)

### Advisor root
- `GET /advisor`
  - Access: Advisor only
  - Redirect:
    - If no claimed business yet:
      - show "Complete claim" CTA → `/claim`
    - else:
      - `/advisor/leads`

### Leads inbox
- `GET /advisor/leads`
  - Access: Advisor only
  - Authorization:
    - advisor must be associated with a business (AdvisorBusinessRole OR advisor_profile.business_id)
  - Query params:
    - status, sort, search

### Lead detail
- `GET /advisor/leads/:lead_id`
  - Access: Advisor only
  - Authorization:
    - lead.business_id == advisor.business_id

### Lead actions
- `PATCH /api/advisor/leads/:lead_id`
  - Access: Advisor only
  - Authorization:
    - same as above
  - Allowed updates:
    - status transitions
    - assigned_to (if teams)
  - Requires:
    - decline reason if status=declined

### Advisor messages (optional consolidated)
- `GET /advisor/messages`
  - Access: Advisor only

### Conversation detail (advisor)
- `GET /advisor/messages/:conversation_id`
  - Access: Advisor only
  - Authorization:
    - conversation.lead.business_id == advisor.business_id

### Send message (advisor)
- `POST /api/conversations/:conversation_id/messages`
  - Access: Advisor only
  - Authorization:
    - as above

### Clients list (optional V1)
- `GET /advisor/clients`
  - Access: Advisor only
  - Authorization:
    - business scope
  - Notes:
    - list of accepted leads / client_records

### Client workspace
- `GET /advisor/clients/:client_record_id`
  - Access: Advisor only
  - Authorization:
    - client_record.business_id == advisor.business_id

### Notes
- `GET /advisor/clients/:client_record_id/notes`
- `POST /api/advisor/clients/:client_record_id/notes`
  - Access: Advisor only
  - Authorization:
    - business scope
  - Notes:
    - create note + revision 1

### Profile editor
- `GET /advisor/profile`
  - Access: Advisor only
- `PATCH /api/advisor/profile`
  - Access: Advisor only

### Business listing editor
- `GET /advisor/business`
  - Access: Advisor only
  - Authorization:
    - advisor has owner/staff role on business
- `PATCH /api/advisor/business`
  - Access: Advisor only

### Templates (messaging/templates library)
- `GET /advisor/templates`
- `POST /api/advisor/templates`
  - Access: Advisor only

---

## 6) Copilot (Advisor-only)

### Copilot home (optional)
- `GET /advisor/copilot`
  - Access: Advisor only
  - Notes: recent runs + create run

### Create run in client context (recommended)
- `GET /advisor/clients/:client_record_id/copilot`
  - Access: Advisor only
  - Authorization:
    - client_record.business_id == advisor.business_id

### Create Copilot run (API)
- `POST /api/copilot/runs`
  - Access: Advisor only
  - Body:
    - client_record_id (required)
    - input_artifacts (text + files)
    - meeting_type, pack selection
    - tone, channel
  - Authorization:
    - business scope
  - Guardrails:
    - store prompt_version + model_id
    - run safety checker

### Read Copilot run
- `GET /api/copilot/runs/:run_id`
  - Access: Advisor only
  - Authorization:
    - run.business_id == advisor.business_id

### Save output to Notes/Tasks
- `POST /api/copilot/outputs/:output_id/finalize`
  - Access: Advisor only
  - Authorization:
    - output belongs to advisor business
  - Effects:
    - create AdvisorNote + AdvisorNoteRevision
    - create Task(s) if action items selected

### Edit output (optional)
- `PATCH /api/copilot/outputs/:output_id`
  - Access: Advisor only
  - Stores edited_content

---

## 7) Admin Console

### Admin root
- `GET /admin`
  - Access: Admin only
  - Default: `/admin/claims`

### Claims queue
- `GET /admin/claims`
  - Access: Admin only

### Claim detail
- `GET /admin/claims/:claim_request_id`
  - Access: Admin only

### Claim actions
- `PATCH /api/admin/claims/:claim_request_id`
  - Access: Admin only
  - Allowed:
    - approve (assign owner role)
    - needs_more_info (send checklist)
    - deny (reason + lockout)

### Credentials queue
- `GET /admin/credentials`
  - Access: Admin only
- `PATCH /api/admin/credentials/:credential_id`
  - Access: Admin only
  - Allowed:
    - set verification_status + source + verified_at

### Reviews moderation
- `GET /admin/reviews`
  - Access: Admin only
- `PATCH /api/admin/reviews/:review_id`
  - Access: Admin only
  - Allowed:
    - publish/reject/hide

### Listings moderation
- `GET /admin/listings`
  - Access: Admin only
- `PATCH /api/admin/listings/:listing_id`
  - Access: Admin only
  - Allowed:
    - suspend/activate
    - search_boost overrides (if used)

### Reports queue
- `GET /admin/reports`
  - Access: Admin only
- `PATCH /api/admin/reports/:report_id`
  - Access: Admin only

---

## 8) Role Upgrade / Edge Cases

### Consumer → Advisor upgrade
- Triggered when a consumer initiates a claim:
  - On `/claim` submit, prompt: "Create advisor account"
- Rule:
  - One user can hold one primary role at a time (simplest V1)
  - Alternative: multi-role accounts (V2)

### Business access checks (Advisor)
Authorization must verify:
- advisor_profile.business_id == target business_id
OR
- exists advisor_business_role where (user_id, business_id, status=active)

### Listing visibility rules
- Soft-deleted or inactive listings:
  - Not shown in `/search`
  - `/advisors/:slug` shows “unavailable” state

---

## 9) Minimal Middleware Guards (Implementation)
- `requireAuth()`
- `requireRole(role)`
- `requireConsumer()`
- `requireAdvisor()`
- `requireAdmin()`
- `requireBusinessScope(business_id)`:
  - checks advisor-business association
- `requireLeadScope(lead_id)`:
  - consumer owns lead OR advisor business owns lead OR admin

---

## 10) Suggested Redirect Rules
- If unauthenticated user tries to submit lead:
  - redirect to `/login?next=/request/:listing_id`
- If advisor without claimed business goes to dashboard:
  - redirect to `/claim`
- If wrong role:
  - consumer hitting `/advisor` → redirect `/app`
  - advisor hitting `/app` → redirect `/advisor`
  - non-admin hitting `/admin` → 403 page
```
