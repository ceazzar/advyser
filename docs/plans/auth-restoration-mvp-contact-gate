â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    ADVYSER - ENGINEERING PLAN (REVISED)
                    Auth Flow Restoration + Contact Details Gate
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Date:    2026-02-25
Status:  IN PROGRESS - overlap implementation underway
Branch:  main
Backup:  codex/non-public-backup-20260211


ğŸ“‹ Context
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Auth pages were removed during MVP pruning. The product requirement for this phase is:
users must sign up/log in before seeing advisor contact details (email/phone/website).

Current state:
- Auth routes are blocked by middleware.
- Advisor contact details are returned by public API and rendered publicly.
- Consumer default redirect still points to /dashboard (disabled in MVP mode).

This revised plan restores auth and enforces the contact gate at BOTH UI and API layers.

Implementation progress snapshot:
- Completed: auth route restoration, middleware unblocking, consumer redirect defaults, callback fallback hardening.
- Completed: listing-detail API redaction + `contactUnlocked` flag + private cache for authenticated responses.
- Completed: advisor profile UI contact gate and request-intro pre-auth gate.
- Completed: authenticated-only checks on `POST /api/leads` and `POST /api/match-requests`.
- Remaining: optional refactors from React Doctor warnings and full regression pass across entire repo.


ğŸ¯ User Flow Being Enabled
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Primary flow:
1. User visits /advisors/[slug]
2. Contact details are hidden behind gate card
3. User clicks Sign Up or Log In with redirect back to advisor page
4. User verifies email (if signup)
5. User is returned to safe destination
6. Advisor contact details become visible

Lead-form progressive flow:
1. User submits /request-intro form
2. Success state shows "Complete your profile"
3. CTA links to /signup with pre-filled email and safe redirect
4. User verifies email
5. User lands on redirected page (default /)


ğŸ”‘ Design Decisions
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- Contact gate enforcement:
  - UI gate on advisor page (locked card for anonymous users)
  - API redaction for anonymous requests (no contact fields returned)
  - Rationale: Prevent trivial bypass via browser network tab or direct API calls

- Consumer default route:
  - /dashboard -> /
  - Rationale: /dashboard remains disabled in MVP mode

- Redirect handling:
  - Preserve role-based safe redirect checks
  - Signup must propagate redirect into verification callback

- Password reset:
  - Restore both forgot-password and reset-password pages
  - Rationale: reset flow already depends on /reset-password callback target


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                           COMMIT 1 - Auth Infrastructure
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“¦ 1A - Restore Auth Pages From Backup (6 files)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Restore from backup branch:

  git checkout codex/non-public-backup-20260211 -- \
    site/src/app/login/page.tsx \
    site/src/app/signup/page.tsx \
    site/src/app/verify/page.tsx \
    site/src/app/auth/callback/route.ts \
    site/src/app/forgot-password/page.tsx \
    site/src/app/reset-password/page.tsx


ğŸ”§ 1B - Unblock Auth Routes in Middleware
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

File: site/src/middleware.ts

Remove these entries from DISABLED_ROUTE_PREFIXES:
- "/login"
- "/signup"
- "/verify"
- "/forgot-password"
- "/reset-password"
- "/auth"

Keep /dashboard, /advisor, /admin, /claim blocked.


ğŸ”Œ 1C - Add AuthProvider to Root Layout
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

File: site/src/app/layout.tsx

- Import AuthProvider from @/lib/auth-context
- Wrap existing app shell so AuthProvider contains ShortlistProvider

Target structure:
  <AuthProvider>
    <ShortlistProvider>
      <main ...>{children}</main>
      <CookieConsentBanner />
    </ShortlistProvider>
  </AuthProvider>


ğŸ—ºï¸  1D - Fix Auth Routing Defaults + Allowed Paths
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

File: site/src/lib/auth-routing.ts

Changes:
- ROLE_DEFAULT_ROUTE.consumer: "/dashboard" -> "/"
- ROLE_ALLOWED_PREFIXES.consumer:
  from ["/dashboard"]
  to ["/", "/advisors", "/search", "/request-intro", "/resources", "/how-it-works"]

Also update any hardcoded consumer dashboard redirects:
- site/src/lib/auth-context.tsx (useRequireAuth role redirect map)
  - consumer: "/dashboard" -> "/"


ğŸ” 1E - Preserve Signup Redirect Through Email Verification
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Files:
- site/src/lib/auth-actions.ts
- site/src/app/signup/page.tsx

Required behavior:
- Signup page reads optional `redirect` query param.
- On submit, include redirect in FormData (e.g. "redirect").
- Server action signUp sanitizes/validates redirect and appends it to emailRedirectTo:
    /auth/callback?next=...
- If redirect missing/invalid, fallback to role default.

Validation rules:
- Reuse redirect safety logic (sanitize + allowed prefix checks).
- Never allow external URLs.


ğŸ›¡ï¸  1F - Harden Callback Defaults
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

File: site/src/app/auth/callback/route.ts

Change fallback behavior:
- default raw next: "/dashboard" -> "/"
- unsafe fallback path: "/dashboard" -> "/"


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      COMMIT 2 - Contact Gate (API + UI)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”’ 2A - Enforce Contact Redaction in Listing Detail API
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

File: site/src/app/api/listings/[id]/route.ts

Problem:
- API currently returns website/email/phone to anonymous users.

Required changes:
1. Resolve current auth user from server-side supabase client.
2. Determine contact visibility:
   - logged in user -> show contact fields
   - anonymous -> set contact fields to null
3. Add response flag for UI clarity:
   - `contactUnlocked: boolean`
4. Cache policy:
   - anonymous redacted response may remain public cacheable
   - authenticated response must be private/no-store (avoid shared cache leaks)


ğŸ§© 2B - Gate Contact Section in Advisor Profile UI
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

File: site/src/app/advisors/[slug]/page.tsx

- Add locked-state UI card for anonymous users.
- Include Sign Up and Log In buttons with redirect back to current advisor slug.
- Keep loading placeholder to avoid auth-state flash.
- Prefer API-provided `contactUnlocked` as source of truth for display.

Gate CTA targets:
- /signup?redirect=/advisors/[slug]
- /login?redirect=/advisors/[slug]


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                   COMMIT 3 - Progressive Registration CTA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ 3A - Add "Complete your profile" CTA to Request-Intro Success
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

File: site/src/app/request-intro/page.tsx

On success state:
- Add primary CTA block above existing success action buttons.
- Link to signup with captured email and safe redirect:
  /signup?email={encodedEmail}&redirect=/
- Demote existing buttons to secondary/ghost styles.


âœ‰ï¸  3B - Support Email Pre-fill + Redirect Params on Signup
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

File: site/src/app/signup/page.tsx

- Use component split with Suspense to read search params.
- Read:
  - `email` for prefill
  - `redirect` for post-verify return
- Keep state controlled inputs intact.


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                           COMMIT 4 - Tests + Verification
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… 4A - Update Unit Tests for New Consumer Routing
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

File: site/src/lib/auth-routing.test.ts

Update expectations:
- consumer default route is "/"
- consumer allowed paths include /advisors and other public routes
- disallowed paths remain /admin, /advisor, etc.


âœ… 4B - Update E2E Auth Setup Redirect Expectations
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

File: site/e2e/auth.setup.ts

Update consumer login assertion:
- from /dashboard to /
- advisor remains /advisor


âœ… 4C - Add/Update API Contract Test for Contact Redaction
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Add or extend API test coverage to validate:
- anonymous GET /api/listings/[id] => email/phone/website are null
- authenticated GET /api/listings/[id] => contact fields populated when available


âœ… 4D - Manual Verification Paths
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Path A - Anonymous advisor profile gate:
1. Visit /advisors/[slug] logged out
2. Verify contact fields hidden and lock card visible
3. Verify API payload does not expose contact fields

Path B - Signup from gate:
1. Click Sign Up Free from advisor page
2. Complete signup
3. Verify callback returns to advisor page (safe redirect)
4. Confirm contact details visible

Path C - Login from gate:
1. Click Log In from advisor page
2. Complete login
3. Confirm redirect back to advisor page and contact visible

Path D - Forgot/reset password:
1. Visit /forgot-password
2. Request reset email
3. Use callback link to /reset-password
4. Set new password and return to login

Path E - Progressive registration:
1. Submit /request-intro
2. Click "Complete your profile"
3. Confirm signup email pre-filled and redirect works


ğŸ§ª Verification Commands
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  cd site
  npm run lint
  npm run test:run
  npx tsc --noEmit
  npx playwright test e2e/tests/mvp1-public.spec.ts e2e/tests/mvp1-accessibility.spec.ts
  ENABLE_AUTH_E2E=true npx playwright test e2e/auth.setup.ts


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                FILES MODIFIED (PLAN)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Commit 1:
- site/src/middleware.ts
- site/src/app/layout.tsx
- site/src/lib/auth-routing.ts
- site/src/lib/auth-context.tsx
- site/src/lib/auth-actions.ts
- site/src/app/login/page.tsx (restore)
- site/src/app/signup/page.tsx (restore + params support)
- site/src/app/verify/page.tsx (restore)
- site/src/app/auth/callback/route.ts (restore + fallback hardening)
- site/src/app/forgot-password/page.tsx (restore)
- site/src/app/reset-password/page.tsx (restore)

Commit 2:
- site/src/app/api/listings/[id]/route.ts
- site/src/app/advisors/[slug]/page.tsx

Commit 3:
- site/src/app/request-intro/page.tsx
- site/src/app/signup/page.tsx

Commit 4:
- site/src/lib/auth-routing.test.ts
- site/e2e/auth.setup.ts
- API test file for listing detail redaction (new or updated)


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
End of Revised Document
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
